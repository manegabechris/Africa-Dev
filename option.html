<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bienvenue sur Africa Dev
  </title>
  <link rel="stylesheet" href="Styles.CSS">
</head>
<body>

  <header>
    <div class="logo"><div class="mark">AD</div><div>
      <div>Africa <strong>Dev</strong></div>
      <small class="tagline">Formation | Communaut√© | Ressources</small>
    </div></div>
    <nav aria-label="navigation">
      <div id="userArea"><a href="inscription.html" class="nav-cta">S'inscrire</a></div>
    </nav>
  </header>

  <!-- Toast / notification -->
  <div id="toast" class="toast"></div>

  <section class="hero">
    <h1>Donnez vie √† vos comp√©tences digitales</h1>
    <p>Explorez des parcours pratiques et adapt√©s, avec mentorat et projets r√©els. Choisissez un domaine pour commencer.</p>
    <a class="cta" href="#grid">Voir les formations</a>

    <div class="search-container">
      <input type="text" id="search-input" placeholder="Rechercher un domaine...">
      <ul class="search-results" id="search-results" role="listbox" aria-label="R√©sultats de recherche"></ul>
    </div>

    <!-- Mes modules inscrits -->
    <div id="myModules" aria-live="polite" class="hidden">
      <div class="title">Mes modules</div>
      <div class="list" id="myModulesList"></div>
      <label class="filter-control"><input type="checkbox" id="filterOnlyMine">Afficher uniquement mes modules</label>
      <div id="filterEmpty" role="status" aria-live="polite" class="hidden">Vous n'√™tes inscrit √† aucun module.</div>
    </div>
  </section>

  <main id="grid" class="grid">
    <div class="card" data-page="transformation digital.html" tabindex="0">
      <div class="icon">üí°</div>
      <h3>Transformation Digitale</h3>
      <p>Adoptez les outils num√©riques et pilotez la transformation des organisations.</p>
    </div>

    <div class="card" data-page="developement web.html" tabindex="0">
      <div class="icon">üñ•Ô∏è</div>
      <h3>D√©veloppement Web</h3>
      <p>Apprenez HTML, CSS, JavaScript et frameworks modernes pour construire des applications web.</p>
    </div>

    <div class="card" data-page="marketing digital.html" tabindex="0">
      <div class="icon">üì£</div>
      <h3>Marketing Digital</h3>
      <p>Strat√©gie de contenu, SEO, r√©seaux sociaux et campagnes payantes pour booster la visibilit√©.</p>
    </div>

    <div class="card" data-page="groupe chat.html" tabindex="0">
      <div class="icon">üí¨</div>
      <h3>Notre Groupe Chat</h3>
      <p>Rejoignez la communaut√© pour √©changer, apprendre et collaborer avec d'autres membres.</p>
    </div>
  </main>

  <footer>
    <div>¬© <span id="year"></span> Africa Dev ‚Äî Tous droits r√©serv√©s. <span class="footer-note">Suivez-nous pour les mises √† jour et √©v√©nements</span></div>
  </footer>

  <script>
    const pages = {
      "transformation digitale": "transformation digital.html",
      "d√©veloppement web": "developement web.html",
      "marketing digital": "marketing digital.html",
      "notre groupe chat": "groupe chat.html"
    };

    const domains = Object.keys(pages);

    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');

    // Normalize strings (remove diacritics + lowercase) for accent-insensitive search
    function normalize(s){
      if (!s) return '';
      try { return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase(); }
      catch(e){ return s.toLowerCase(); }
    }

    function renderResults(list) {
      resultsContainer.innerHTML = '';
      if (!list.length) { resultsContainer.style.display = 'none'; return; }
      resultsContainer.style.display = 'block';
      list.forEach(domain => {
        const li = document.createElement('li');
        li.setAttribute('role','option');
        li.setAttribute('tabindex','0');
        const icon = document.createElement('span'); icon.className = 'icon';
        const key = domain.toLowerCase();
        icon.textContent = key.includes('web') ? 'üñ•Ô∏è' : key.includes('marketing') ? 'üì£' : key.includes('groupe') ? 'üí¨' : 'üí°';
        const span = document.createElement('span'); span.textContent = ' ' + domain.replace(/\b\w/g, l => l.toUpperCase());
        li.appendChild(icon); li.appendChild(span);

        const go = () => {
          const u = getCurrentUser();
          if (!u) {
            showToast(`<div>Connectez-vous pour acc√©der √† <strong>${domain}</strong>.<br><a href=\"inscription.html\" style=\"color:#ffd1c0;font-weight:600;\">S'inscrire</a></div>`, 4500);
            return;
          }
          window.location.href = pages[domain];
        };

        li.addEventListener('click', go);
        li.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); go(); } });
        resultsContainer.appendChild(li);
      });
    }

    input.addEventListener('input', function() {
      const q = normalize(this.value.trim());
      if (!q) { resultsContainer.style.display = 'none'; return; }
      const filtered = domains.filter(d => normalize(d).includes(q));
      renderResults(filtered);
    });

    // Keyboard navigation for results: ArrowDown to move into list, Escape to close
    input.addEventListener('keydown', function(e){
      const items = resultsContainer.querySelectorAll('li');
      if (!items.length) return;
      const active = document.activeElement;
      if (e.key === 'ArrowDown') { e.preventDefault(); if (active === input) items[0].focus(); else (active.nextElementSibling || items[0]).focus(); }
      if (e.key === 'Escape') { resultsContainer.style.display = 'none'; input.blur(); }
    });

    // Utility: toast notification
    function showToast(html, timeout = 3500) {
      const t = document.getElementById('toast');
      t.innerHTML = html;
      t.style.display = 'block';
      clearTimeout(t._timeout);
      t._timeout = setTimeout(() => { t.style.display = 'none'; }, timeout);
    }

    // Manage current user UI
    function getCurrentUser() { try { return JSON.parse(localStorage.getItem('currentUser')); } catch(e) { return null; } }
    function updateUserUI() {
      const userArea = document.getElementById('userArea');
      const u = getCurrentUser();
      if (u) {
        userArea.innerHTML = `<div class="user-inline">
            <span class="user-greeting">Bonjour, <strong class="user-name">${u.username || u.name}</strong></span>
            <button id="logoutBtn" class="btn-logout">D√©connexion</button>
          </div>`;
        document.getElementById('logoutBtn').addEventListener('click', () => {
          localStorage.removeItem('currentUser');
          updateUserUI();
          showToast('Vous √™tes d√©connect√©.');
        });
      } else {
        userArea.innerHTML = `<a href="inscription.html" class="nav-cta">S'inscrire / Se connecter</a>`;
      }
    }

    // Cards click / keyboard support (protect for anonymous users)
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => {
        const u = getCurrentUser();
        if (!u) {
          showToast(`<div>Connectez-vous pour acc√©der √† cette formation.<br><a href=\"inscription.html\" class=\"toast-cta\">S'inscrire</a></div>`, 4500);
          return;
        }
        window.location.href = card.dataset.page;
      });
      card.addEventListener('keypress', (e) => { if (e.key === 'Enter') card.click(); });
    });


    // Enrollments helpers
    function domainToSlug(domain){ return normalize(domain).replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
    function getEnrollments(){ try { return JSON.parse(localStorage.getItem('enrollments')||'[]'); } catch(e){ return []; } }

    function renderEnrolledModules(){
      const list = getEnrollments();
      const container = document.getElementById('myModules');
      const listEl = document.getElementById('myModulesList');
      listEl.innerHTML = '';
      if (!list.length){ container.style.display = 'none'; }
      else { container.style.display = 'block'; }

      // build inverse lookup from pages domain -> page
      Object.keys(pages).forEach(domain => {
        const slug = domainToSlug(domain);
        if (list.includes(slug)){
          const a = document.createElement('a'); a.href = pages[domain]; a.textContent = domain.replace(/\b\w/g, l => l.toUpperCase());
          listEl.appendChild(a);
        }
      });

      // update cards badges & CTA
      const user = getCurrentUser();
      document.querySelectorAll('.card').forEach(card => {
        const title = (card.querySelector('h3')||{}).textContent || '';
        const slug = domainToSlug(title.toLowerCase());

        // remove previous badges if any
        const existingEnroll = card.querySelector('.enroll-badge'); if (existingEnroll) existingEnroll.remove();
        const existingCTA = card.querySelector('.cta-badge'); if (existingCTA) existingCTA.remove();
        card.classList.remove('enrolled');
        card.classList.remove('hidden');

        if (list.includes(slug)){
          const meta = card.querySelector('.meta') || (function(){ const m = document.createElement('div'); m.className='meta'; card.appendChild(m); return m; })();
          const badge = document.createElement('span'); badge.className = 'enroll-badge'; badge.textContent = 'Inscrit';
          meta.appendChild(badge);
          card.classList.add('enrolled');
        } else {
          // ensure the card isn't display:none while Masonry calculates
          card.classList.remove('hidden');
          // show CTA badge; click behaviour depends on login state
          const meta = card.querySelector('.meta') || (function(){ const m = document.createElement('div'); m.className='meta'; card.appendChild(m); return m; })();
          const cta = document.createElement('span'); cta.className = 'cta-badge'; cta.tabIndex = 0;
          if (!user) {
            cta.textContent = "S'inscrire";
            cta.addEventListener('click', (e)=>{ e.stopPropagation(); window.location.href = 'inscription.html'; });
            cta.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); window.location.href = 'inscription.html'; } });
          } else {
            cta.textContent = "S'inscrire";
            const target = card.dataset.page || '#';
            cta.addEventListener('click', (e)=>{ e.stopPropagation(); window.location.href = target; });
            cta.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); window.location.href = target; } });
          }
          meta.appendChild(cta);
        }

        // Community badge for 'Notre Groupe Chat'
        if (slug === 'notre-groupe-chat'){
          let existing = card.querySelector('.community-badge');
          if (!existing){
            const cb = document.createElement('span'); cb.className = 'community-badge'; cb.textContent = 'Communaut√©';
            card.appendChild(cb);
          }
        } else {
          const existing = card.querySelector('.community-badge'); if (existing) existing.remove();
        }
      });

      // After updating badges, apply filter if needed
      applyFilter();
    }

    // Init UI
    updateUserUI();
    // Expose for other pages and call to render
    window.updateEnrollUI = renderEnrolledModules;
    renderEnrolledModules();

    // Filter behavior: persist preference and apply filter
    const filterCheckbox = document.getElementById('filterOnlyMine');
    function applyFilter(){
      if (!filterCheckbox) return;
      const checked = filterCheckbox.checked;
      localStorage.setItem('filterMyModules', checked ? '1' : '0');
      const enrolls = getEnrollments();
      const filterEmptyEl = document.getElementById('filterEmpty');
      let anyVisible = false;

      document.querySelectorAll('.card').forEach(card => {
        const title = (card.querySelector('h3')||{}).textContent || '';
        const slug = domainToSlug(title.toLowerCase());

        const shouldHide = checked && !enrolls.includes(slug);

        if (shouldHide) {
          // perform hide, let Masonry animate the reflow
          card.classList.add('hidden');
        } else {
          // ensure visible
          card.classList.remove('hidden');
          anyVisible = true;
        }
      });

      // show message if checkbox checked but nothing is visible
      if (checked && !anyVisible){
        if (filterEmptyEl) filterEmptyEl.style.display = 'block';
      } else {
        if (filterEmptyEl) filterEmptyEl.style.display = 'none';
      }

      // request Masonry relayout to animate grid rearrangement
      relayoutGrid();
    }

    if (filterCheckbox){
      // restore state
      filterCheckbox.checked = localStorage.getItem('filterMyModules') === '1';
      filterCheckbox.addEventListener('change', applyFilter);
      applyFilter();
    }

    // Listen for storage events (other tabs updates)
    window.addEventListener('storage', (e)=>{
      if (e.key === 'enrollments') renderEnrolledModules();
      if (e.key === 'filterMyModules' && filterCheckbox) { filterCheckbox.checked = localStorage.getItem('filterMyModules') === '1'; applyFilter(); }
    });

    // Masonry: load and initialize to animate grid rearrangement
    const gridEl = document.querySelector('.grid');
    function initMasonry(){
      if (!window.Masonry || !gridEl) return;
      try {
        window.msnry = new Masonry(gridEl, { itemSelector: '.card', columnWidth: '.card', percentPosition: true, transitionDuration: '0.38s' });
      } catch(e) { console.warn('Masonry init failed', e); }
    }
    // load Masonry from CDN and init
    (function loadMasonry(){
      if (window.Masonry) return initMasonry();
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js';
      s.onload = initMasonry;
      s.onerror = function(){ console.warn('Failed to load Masonry'); };
      document.body.appendChild(s);
    })();

    // Helper to relayout with small delay
    function relayoutGrid(){ if (window.msnry) { setTimeout(()=>{ window.msnry.layout(); }, 60); } }

    // Ensure relayout after enroll/render changes
    const origRender = renderEnrolledModules; renderEnrolledModules = function(){ origRender(); relayoutGrid(); };

    // Set footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    // Close results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) { resultsContainer.style.display = 'none'; }
    });
  </script>

</body>
</html>
